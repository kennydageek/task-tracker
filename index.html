<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Tasks</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%230c0c0c'/%3E%3Cpath d='M7 16.5l6 6L25 9' stroke='%23c8f54a' stroke-width='3.2' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3C/svg%3E">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
:root{--accent:#c8f54a;--accent-dim:rgba(200,245,74,.09);--github:#7eb8f7;--danger:#ff5959;--warn:#f7c07e;--tr:background .2s,color .2s,border-color .2s;}
[data-theme="dark"]{--bg:#0c0c0c;--surface:#141414;--surface2:#1e1e1e;--border:#2a2a2a;--border2:#383838;--text:#e8e8e0;--muted:#606058;--muted2:#404038;--topbar-bg:rgba(12,12,12,.94);--input-bg:#0c0c0c;--glow:rgba(200,245,74,.03);}
[data-theme="light"]{--bg:#f4f4ef;--surface:#fff;--surface2:#ededea;--border:#d8d8d2;--border2:#b8b8b0;--text:#18181a;--muted:#80807a;--muted2:#b0b0aa;--topbar-bg:rgba(244,244,239,.94);--input-bg:#f4f4ef;--glow:rgba(200,245,74,.05);}
body{background:var(--bg);color:var(--text);font-family:'DM Mono',monospace;font-size:15px;min-height:100vh;overflow-x:hidden;transition:var(--tr);}
body::before{content:'';position:fixed;top:-200px;right:-200px;width:600px;height:600px;background:radial-gradient(circle,var(--glow) 0%,transparent 70%);pointer-events:none;z-index:0;}
@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes popIn{from{opacity:0;transform:scale(.96)}to{opacity:1;transform:scale(1)}}
@keyframes slideR{from{opacity:0;transform:translateX(10px)}to{opacity:1;transform:translateX(0)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* THEME TOGGLE */
.theme-toggle{display:flex;align-items:center;background:var(--surface2);border:1px solid var(--border2);border-radius:24px;padding:3px;transition:var(--tr);}
.tt-btn{background:none;border:none;cursor:pointer;width:32px;height:26px;border-radius:18px;display:grid;place-items:center;font-size:15px;transition:background .2s;color:var(--muted);}
.tt-btn.active{background:var(--surface);color:var(--text);box-shadow:0 1px 4px rgba(0,0,0,.18);}

/* PROFILE */
#profile-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:48px 24px;animation:fadeIn .4s ease;position:relative;z-index:1;}
.profile-box{width:100%;max-width:520px;animation:popIn .35s ease;}
.profile-logo{font-family:'Playfair Display',serif;font-size:34px;font-weight:700;margin-bottom:6px;}
.profile-logo em{font-style:italic;color:var(--accent);}
.profile-tagline{font-size:12px;color:var(--muted);letter-spacing:.18em;text-transform:uppercase;margin-bottom:44px;}
.section-lbl{font-size:11px;color:var(--muted);letter-spacing:.18em;text-transform:uppercase;margin-bottom:12px;}
.profile-list{display:flex;flex-direction:column;gap:6px;margin-bottom:26px;}
.profile-card{display:flex;align-items:center;justify-content:space-between;background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:16px 18px;cursor:pointer;transition:var(--tr);}
.profile-card:hover{border-color:var(--border2);}
.pc-left{display:flex;align-items:center;gap:14px;}
.p-avatar{width:42px;height:42px;border-radius:50%;display:grid;place-items:center;font-size:15px;font-weight:700;color:#0c0c0c;flex-shrink:0;}
.p-name{font-size:15px;font-weight:500;}.p-meta{font-size:12px;color:var(--muted);margin-top:3px;}.p-arrow{color:var(--muted2);font-size:14px;}
.divider{height:1px;background:var(--border);margin:22px 0;}
.new-profile-row{display:flex;border:1px solid var(--border2);border-radius:4px;overflow:hidden;transition:border-color .2s;margin-bottom:26px;}
.new-profile-row:focus-within{border-color:var(--accent);}
.np-input{flex:1;background:var(--surface);border:none;outline:none;padding:14px 18px;color:var(--text);font-family:'DM Mono',monospace;font-size:14px;}
.np-input::placeholder{color:var(--muted2);}
.np-btn{background:var(--accent);color:#0c0c0c;border:none;font-family:'DM Mono',monospace;font-size:12px;font-weight:700;padding:14px 20px;cursor:pointer;transition:background .15s;}
.np-btn:hover{background:#d4f96a;}
.status-cards{display:flex;flex-direction:column;gap:8px;}
.status-card{display:flex;align-items:center;gap:12px;background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:14px 16px;font-size:13px;color:var(--muted);transition:var(--tr);}
.s-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;background:var(--muted2);transition:all .2s;}
.s-dot.on{background:var(--accent);box-shadow:0 0 7px var(--accent);}.s-dot.gh{background:var(--github);box-shadow:0 0 7px var(--github);}.s-dot.err{background:var(--danger);}
.s-text{flex:1;}
.s-btn{background:none;border:1px solid var(--border2);color:var(--muted);font-family:'DM Mono',monospace;font-size:11px;padding:6px 12px;cursor:pointer;border-radius:2px;transition:all .15s;white-space:nowrap;}
.s-btn:hover{color:var(--text);border-color:var(--muted);}
.logout-row{margin-top:20px;padding-top:18px;border-top:1px solid var(--border);}
.logout-btn{background:none;border:1px solid var(--border2);color:var(--muted);font-family:'DM Mono',monospace;font-size:12px;padding:10px 18px;cursor:pointer;border-radius:4px;transition:all .15s;width:100%;}
.logout-btn:hover{color:var(--danger);border-color:var(--danger);}
.profile-theme-row{display:flex;align-items:center;justify-content:space-between;margin-top:20px;font-size:13px;color:var(--muted);}

/* TOPBAR */
#app{display:none;flex-direction:column;min-height:100vh;}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 24px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--topbar-bg);backdrop-filter:blur(14px);z-index:100;transition:var(--tr);gap:20px;}
.topbar-left{display:flex;align-items:center;gap:12px;min-width:0;}
.brand{font-family:'Playfair Display',serif;font-size:20px;font-weight:700;white-space:nowrap;}.brand em{font-style:italic;color:var(--accent);}
.topbar-center{display:flex;gap:2px;flex:1;justify-content:center;}
.nav-tab{background:none;border:none;border-bottom:2px solid transparent;color:var(--muted);font-family:'DM Mono',monospace;font-size:11px;letter-spacing:.12em;text-transform:uppercase;padding:8px 14px;cursor:pointer;border-radius:0;transition:all .15s;}
.nav-tab:hover{color:var(--text);}.nav-tab.active{color:var(--accent);border-bottom-color:var(--accent);}
.main-tabs{display:none;}
.topbar-right{display:flex;align-items:center;gap:8px;}
.top-btn-icon{display:none;}
.sync-pill{display:flex;align-items:center;justify-content:center;gap:6px;background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:6px 12px;font-size:11px;color:var(--muted);cursor:pointer;transition:var(--tr);min-width:36px;}
.sync-pill:hover{border-color:var(--border2);}
.sync-dot{width:6px;height:6px;border-radius:50%;background:var(--muted2);flex-shrink:0;}
.sync-dot.synced{background:var(--github);box-shadow:0 0 5px var(--github);}.sync-dot.syncing{background:var(--accent);animation:spin 1s linear infinite;border-radius:0;clip-path:polygon(50% 0%,100% 100%,0% 100%);}.sync-dot.error{background:var(--danger);}
.top-btn{background:none;border:1px solid var(--border2);color:var(--muted);font-family:'DM Mono',monospace;font-size:11px;letter-spacing:.08em;text-transform:uppercase;padding:6px 12px;cursor:pointer;border-radius:8px;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:5px;min-width:36px;}
.top-btn:hover{color:var(--accent);border-color:var(--accent);}
.dirty-dot{width:6px;height:6px;border-radius:50%;background:var(--muted2);transition:background .2s;flex-shrink:0;}.dirty-dot.on{background:var(--accent);box-shadow:0 0 5px var(--accent);}
.user-chip{display:flex;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:4px 12px 4px 4px;cursor:pointer;font-size:12px;color:var(--muted);transition:var(--tr);}
.user-chip:hover{border-color:var(--border2);color:var(--text);}
.uc-avatar{width:26px;height:26px;border-radius:50%;display:grid;place-items:center;font-size:10px;font-weight:700;color:#0c0c0c;flex-shrink:0;}
.sidebar-toggle-text{display:inline;}

/* APP BODY */
.app-body{display:flex;flex:1;overflow:hidden;}

/* SIDEBAR */
.sidebar{width:220px;flex-shrink:0;border-right:1px solid var(--border);padding:20px 14px;position:sticky;top:57px;height:calc(100vh - 57px);overflow-y:auto;display:flex;flex-direction:column;gap:6px;transition:var(--tr);background:var(--bg);}
.sb-lbl{font-size:10px;color:var(--muted2);letter-spacing:.2em;text-transform:uppercase;padding:0 10px;margin-bottom:10px;font-weight:500;}
.cat-btn{display:flex;align-items:center;justify-content:space-between;background:var(--surface);border:1px solid var(--border);border-left:3px solid transparent;border-radius:8px;padding:12px 14px;cursor:pointer;width:100%;text-align:left;color:var(--muted);font-family:'DM Mono',monospace;font-size:13px;letter-spacing:.04em;transition:all .18s;gap:10px;}
.cat-btn:hover{color:var(--text);border-color:var(--border2);background:var(--surface2);}
.cat-btn.active{color:var(--text);background:var(--surface2);border-color:var(--border2);border-left-color:var(--accent);box-shadow:0 1px 3px rgba(0,0,0,.08);}
.cb-left{display:flex;align-items:center;gap:11px;flex:1;min-width:0;}
.cat-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.cat-btn.active .cat-dot{box-shadow:0 0 0 2px var(--surface2),0 0 8px currentColor;}
.cb-name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;}
.cat-badge{font-size:10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:3px 8px;color:var(--muted2);transition:all .15s;flex-shrink:0;}
.cat-btn.active .cat-badge{color:var(--accent);border-color:var(--accent-dim);background:var(--accent-dim);}
.cb-actions{display:none;gap:4px;flex-shrink:0;}.cat-btn:hover .cb-actions,.cat-btn.active .cb-actions{display:flex;}
.cb-action{background:var(--surface);border:1px solid var(--border);cursor:pointer;color:var(--muted2);font-size:12px;width:24px;height:24px;border-radius:4px;display:grid;place-items:center;transition:color .13s,border-color .13s;}
.cb-action:hover{color:var(--text);border-color:var(--border2);}.cb-action.del:hover{color:var(--danger);border-color:var(--danger);}
.sb-div{height:1px;background:var(--border);margin:14px 0;}
.add-cat-btn{background:transparent;border:2px dashed var(--border2);border-radius:8px;padding:12px 14px;color:var(--muted2);font-family:'DM Mono',monospace;font-size:12px;letter-spacing:.06em;cursor:pointer;width:100%;text-align:center;transition:all .15s;}
.add-cat-btn:hover{color:var(--accent);border-color:var(--accent);background:var(--accent-dim);}

/* MAIN PANEL */
.main-panel{flex:1;overflow-y:auto;padding:32px 28px;min-width:0;}
.panel-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:60vh;text-align:center;color:var(--muted);animation:fadeIn .3s ease;}
.panel-empty-icon{font-size:36px;margin-bottom:16px;opacity:.2;}.panel-empty-text{font-size:14px;letter-spacing:.08em;line-height:2.2;}
.panel-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:26px;animation:slideR .25s ease;}
.panel-eyebrow{font-size:11px;letter-spacing:.26em;text-transform:uppercase;margin-bottom:6px;}
.panel-title{font-family:'Playfair Display',serif;font-size:clamp(28px,3.5vw,42px);font-weight:700;line-height:1.05;}
.panel-sub{font-size:13px;color:var(--muted);margin-top:8px;}
.add-proj-bar{display:flex;margin-bottom:18px;border:1px solid var(--border2);border-radius:3px;overflow:hidden;transition:border-color .2s;}
.add-proj-bar:focus-within{border-color:var(--accent);}
.add-proj-input{flex:1;background:var(--surface);border:none;outline:none;padding:13px 16px;color:var(--text);font-family:'DM Mono',monospace;font-size:14px;}
.add-proj-input::placeholder{color:var(--muted2);}
.add-proj-btn{background:var(--accent);color:#0c0c0c;border:none;font-family:'DM Mono',monospace;font-size:12px;font-weight:700;padding:13px 18px;cursor:pointer;transition:background .15s;}
.add-proj-btn:hover{background:#d4f96a;}

/* PROJECT CARDS */
.project-card{background:var(--surface);border:1px solid var(--border);border-radius:3px;margin-bottom:10px;overflow:hidden;animation:fadeUp .2s ease both;transition:var(--tr);}
.project-card:hover{border-color:var(--border2);}
.proj-header{display:flex;align-items:center;gap:11px;padding:14px 18px;user-select:none;transition:background .12s;}
.proj-header:hover{background:rgba(128,128,128,.04);}
.project-card.open .proj-header{border-bottom:1px solid var(--border);}
.proj-chevron{font-size:10px;color:var(--muted);transition:transform .2s;flex-shrink:0;cursor:pointer;}
.project-card.open .proj-chevron{transform:rotate(90deg);}
.proj-name-wrap{flex:1;min-width:0;cursor:pointer;}
.proj-name{font-size:14px;font-weight:500;letter-spacing:.02em;}
.proj-name-input{font-size:14px;font-weight:500;font-family:'DM Mono',monospace;background:var(--surface2);border:1px solid var(--accent);border-radius:2px;padding:3px 9px;color:var(--text);outline:none;width:100%;}
.proj-prog-wrap{display:flex;align-items:center;gap:9px;}
.proj-prog-bar{width:60px;height:3px;background:var(--border2);overflow:hidden;}
.proj-prog-fill{height:100%;transition:width .4s ease;}
.proj-pct{font-size:11px;color:var(--muted);min-width:30px;text-align:right;}
.proj-actions{display:flex;gap:3px;flex-shrink:0;}
.pj-btn{background:none;border:none;color:var(--muted2);cursor:pointer;font-size:15px;padding:3px 6px;border-radius:2px;transition:color .13s;line-height:1;}
.pj-btn:hover{color:var(--text);}.pj-btn.del:hover{color:var(--danger);}.pj-btn.hist:hover{color:var(--github);}

/* TASKS */
.task-row{display:flex;align-items:center;gap:12px;padding:12px 18px;border-bottom:1px solid var(--border);transition:background .1s;animation:fadeUp .16s ease both;}
.task-row:last-of-type{border-bottom:none;}.task-row:hover{background:rgba(128,128,128,.03);}
.task-row.done-row{opacity:.45;}
.task-check{width:18px;height:18px;border:1.5px solid var(--muted2);border-radius:2px;flex-shrink:0;display:grid;place-items:center;cursor:pointer;transition:all .15s;}
.task-check:hover{border-color:var(--accent);}.task-row.done-row .task-check{background:var(--accent);border-color:var(--accent);}
.task-checkmark{opacity:0;color:#0c0c0c;font-size:11px;font-weight:700;transform:scale(0);transition:all .15s;}.task-row.done-row .task-checkmark{opacity:1;transform:scale(1);}
.task-text-wrap{flex:1;min-width:0;}
.task-text{font-size:14px;letter-spacing:.01em;}.task-row.done-row .task-text{text-decoration:line-through;text-decoration-color:var(--muted2);color:var(--muted);}
.task-edit-input{font-size:14px;font-family:'DM Mono',monospace;background:var(--surface2);border:1px solid var(--accent);border-radius:2px;padding:3px 9px;color:var(--text);outline:none;width:100%;}
.task-date{font-size:11px;color:var(--muted2);white-space:nowrap;}
.task-row-actions{display:flex;gap:3px;opacity:0;transition:opacity .15s;flex-shrink:0;}.task-row:hover .task-row-actions{opacity:1;}
.t-btn{background:none;border:none;color:var(--muted2);cursor:pointer;font-size:14px;padding:2px 5px;transition:color .13s;line-height:1;}
.t-btn:hover{color:var(--text);}.t-btn.del:hover{color:var(--danger);}
.done-divider{padding:7px 18px;font-size:10px;letter-spacing:.18em;text-transform:uppercase;color:var(--muted2);border-top:1px solid var(--border);background:rgba(128,128,128,.02);display:flex;align-items:center;gap:8px;}
.done-divider::after{content:'';flex:1;height:1px;background:var(--border);}
.add-task-row{display:flex;align-items:center;gap:9px;padding:11px 18px;border-top:1px solid var(--border);background:rgba(128,128,128,.02);}
.task-inline-input{flex:1;background:none;border:none;outline:none;color:var(--text);font-family:'DM Mono',monospace;font-size:13px;}
.task-inline-input::placeholder{color:var(--muted2);}
.task-inline-add{background:var(--accent);color:#0c0c0c;border:none;font-family:'DM Mono',monospace;font-size:11px;font-weight:700;padding:6px 12px;cursor:pointer;border-radius:2px;transition:background .14s;}
.task-inline-add:hover{background:#d4f96a;}
.proj-empty{padding:15px 18px;font-size:13px;color:var(--muted2);}

/* ANALYTICS */
.analytics-wrap{max-width:820px;}
.period-row{display:flex;gap:5px;margin-bottom:26px;flex-wrap:wrap;}
.pill{background:none;border:1px solid transparent;color:var(--muted);font-family:'DM Mono',monospace;font-size:11px;letter-spacing:.12em;text-transform:uppercase;padding:7px 15px;cursor:pointer;border-radius:2px;transition:all .14s;}
.pill:hover{color:var(--text);border-color:var(--border2);}.pill.active{color:var(--accent);border-color:var(--accent);background:var(--accent-dim);}
.stat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:9px;margin-bottom:11px;}
@media(max-width:600px){.stat-grid{grid-template-columns:repeat(2,1fr);}}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:3px;padding:18px 16px;transition:var(--tr);}
.stat-num{font-family:'Playfair Display',serif;font-size:36px;font-weight:700;line-height:1;margin-bottom:6px;}.stat-num.hi{color:var(--accent);}
.stat-lbl{font-size:10px;color:var(--muted);letter-spacing:.15em;text-transform:uppercase;}
.chart-card{background:var(--surface);border:1px solid var(--border);border-radius:3px;padding:20px;margin-bottom:11px;transition:var(--tr);}
.chart-ttl{font-size:10px;letter-spacing:.2em;text-transform:uppercase;color:var(--muted);margin-bottom:16px;}
.bar-chart-wrap{display:flex;align-items:flex-end;gap:6px;height:110px;}
.bar-col{flex:1;display:flex;flex-direction:column;align-items:center;gap:5px;height:100%;justify-content:flex-end;}
.bar-val{font-size:10px;color:var(--muted);}.bar-body{width:100%;flex:1;display:flex;align-items:flex-end;}
.bar-stack{width:100%;border-radius:2px 2px 0 0;overflow:hidden;display:flex;flex-direction:column-reverse;}
.seg-done{background:var(--accent);opacity:.85;}.seg-pend{background:var(--border2);}
.bar-lbl{font-size:9px;color:var(--muted);white-space:nowrap;}
.legend-row{display:flex;gap:14px;margin-top:10px;flex-wrap:wrap;}
.legend-row-item{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--muted);}
.legend-sq{width:11px;height:11px;border-radius:2px;}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:11px;margin-bottom:11px;}
@media(max-width:560px){.two-col{grid-template-columns:1fr;}}
.donut-wrap{display:flex;align-items:center;gap:18px;}
.donut-legend{flex:1;display:flex;flex-direction:column;gap:9px;}
.legend-item{display:flex;align-items:center;gap:9px;font-size:12px;}
.legend-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}.legend-label{color:var(--muted);flex:1;}.legend-val{color:var(--text);}
.proj-table{width:100%;border-collapse:collapse;}
.proj-table th{font-size:10px;letter-spacing:.15em;text-transform:uppercase;color:var(--muted);padding:0 0 11px;text-align:left;border-bottom:1px solid var(--border);}
.proj-table td{padding:11px 0;border-bottom:1px solid var(--border);font-size:13px;vertical-align:middle;}
.proj-table tr:last-child td{border-bottom:none;}
.proj-row-bar{height:2px;margin-top:5px;}
.proj-cat-dot{display:inline-block;width:7px;height:7px;border-radius:50%;margin-right:7px;vertical-align:middle;}
.heatmap-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;}
.hm-lbl{font-size:9px;color:var(--muted);text-align:center;padding-bottom:4px;}
.hm-cell{aspect-ratio:1;border-radius:2px;background:var(--surface2);position:relative;cursor:default;transition:transform .1s;}
.hm-cell:hover{transform:scale(1.3);z-index:2;}
.hm-cell:hover::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:var(--surface2);border:1px solid var(--border2);color:var(--text);font-size:11px;padding:4px 9px;white-space:nowrap;pointer-events:none;z-index:10;border-radius:2px;}
.insight-row{display:flex;flex-direction:column;gap:12px;}
.insight-item{border-left:2px solid var(--border2);padding-left:12px;}
.insight-lbl{font-size:10px;color:var(--muted);letter-spacing:.15em;text-transform:uppercase;margin-bottom:3px;}
.insight-val{font-size:14px;color:var(--text);}.insight-val em{font-style:normal;font-size:11px;color:var(--muted);margin-left:6px;}

/* HISTORY */
.history-wrap{max-width:820px;}
.history-filters{display:flex;align-items:center;gap:10px;margin-bottom:22px;flex-wrap:wrap;}
.history-filters select,.history-filters input[type=date]{background:var(--surface);border:1px solid var(--border2);border-radius:3px;color:var(--text);font-family:'DM Mono',monospace;font-size:12px;padding:8px 12px;outline:none;cursor:pointer;transition:var(--tr);}
.history-filters select:focus,.history-filters input[type=date]:focus{border-color:var(--accent);}
.history-clear{background:none;border:1px solid var(--border2);color:var(--muted);font-family:'DM Mono',monospace;font-size:11px;padding:8px 14px;cursor:pointer;border-radius:2px;transition:all .15s;}
.history-clear:hover{color:var(--danger);border-color:var(--danger);}
.history-list{display:flex;flex-direction:column;gap:3px;}
.history-entry{display:flex;align-items:flex-start;gap:14px;padding:13px 16px;background:var(--surface);border:1px solid var(--border);border-radius:3px;font-size:13px;transition:var(--tr);}
.history-entry:hover{border-color:var(--border2);}
.he-icon{font-size:15px;flex-shrink:0;margin-top:1px;}
.he-body{flex:1;min-width:0;}.he-action{font-weight:500;margin-bottom:3px;}.he-meta{font-size:11px;color:var(--muted);}
.he-time{font-size:10px;color:var(--muted2);white-space:nowrap;flex-shrink:0;margin-top:2px;}
.he-tag{display:inline-block;font-size:9px;padding:2px 7px;border-radius:10px;margin-right:5px;font-weight:500;letter-spacing:.05em;}
.snapshot-card{background:var(--surface);border:1px solid var(--border);border-radius:3px;padding:18px 20px;margin-bottom:10px;transition:var(--tr);}
.snapshot-date{font-size:10px;letter-spacing:.18em;text-transform:uppercase;color:var(--muted);margin-bottom:12px;}
.snapshot-stats{display:flex;gap:20px;margin-bottom:12px;flex-wrap:wrap;}
.snapshot-stat{font-size:13px;}
.snapshot-tasks{display:flex;flex-direction:column;gap:5px;}
.snapshot-task{font-size:12px;padding:5px 0;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:9px;}
.snapshot-task:last-child{border-bottom:none;}
.st-done{color:var(--accent);font-size:11px;}.st-pending{color:var(--muted2);font-size:11px;}

/* MODALS */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.72);z-index:200;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(5px);}
.modal{background:var(--surface);border:1px solid var(--border2);border-radius:4px;padding:30px 32px;width:500px;max-width:93vw;animation:popIn .2s ease;transition:var(--tr);max-height:90vh;overflow-y:auto;}
.modal h3{font-family:'Playfair Display',serif;font-size:24px;margin-bottom:8px;}
.modal-desc{font-size:13px;color:var(--muted);line-height:1.7;margin-bottom:18px;}
.modal label{font-size:11px;color:var(--muted);letter-spacing:.13em;text-transform:uppercase;display:block;margin-bottom:6px;}
.modal input,.modal textarea{width:100%;background:var(--input-bg);border:1px solid var(--border2);border-radius:3px;padding:11px 14px;color:var(--text);font-family:'DM Mono',monospace;font-size:14px;outline:none;margin-bottom:15px;transition:border-color .2s;resize:none;}
.modal input:focus,.modal textarea:focus{border-color:var(--accent);}
.modal-note{font-size:12px;color:var(--muted2);line-height:1.7;margin-bottom:16px;padding:11px 14px;background:var(--surface2);border-radius:3px;}
.modal-note a{color:var(--github);text-decoration:none;}.modal-note a:hover{text-decoration:underline;}
.color-picker{display:flex;gap:9px;margin-bottom:20px;flex-wrap:wrap;}
.color-swatch{width:26px;height:26px;border-radius:50%;cursor:pointer;border:2.5px solid transparent;transition:border-color .15s,transform .1s;}
.color-swatch:hover{transform:scale(1.18);}.color-swatch.selected{border-color:var(--text);}
.modal-btns{display:flex;gap:9px;justify-content:flex-end;flex-wrap:wrap;}
.modal-cancel{background:none;border:1px solid var(--border2);color:var(--muted);font-family:'DM Mono',monospace;font-size:12px;padding:9px 16px;cursor:pointer;border-radius:2px;transition:all .14s;}
.modal-cancel:hover{color:var(--text);border-color:var(--muted);}
.modal-confirm{background:var(--accent);color:#0c0c0c;border:none;font-family:'DM Mono',monospace;font-size:12px;font-weight:700;padding:9px 18px;cursor:pointer;border-radius:2px;transition:background .14s;}
.modal-confirm:hover{background:#d4f96a;}
.modal-confirm.gh-btn{background:var(--github);}.modal-confirm.gh-btn:hover{background:#a0c8f8;}
.sync-info-row{display:flex;align-items:center;gap:12px;background:var(--surface2);border:1px solid var(--border);border-radius:3px;padding:12px 14px;margin-bottom:14px;font-size:13px;}
.sync-time{font-size:11px;color:var(--muted);margin-bottom:14px;}
.countdown-bar{height:3px;background:var(--border2);border-radius:0;overflow:hidden;margin-bottom:5px;}
.countdown-fill{height:100%;background:var(--github);transition:width 1s linear;}

/* RESET MODAL */
.reset-task-list{max-height:240px;overflow-y:auto;margin-bottom:18px;border:1px solid var(--border);border-radius:3px;}
.reset-task-row{display:flex;align-items:flex-start;gap:10px;padding:11px 14px;border-bottom:1px solid var(--border);font-size:13px;}
.reset-task-row:last-child{border-bottom:none;}
.rt-icon{font-size:14px;flex-shrink:0;margin-top:1px;}

/* PROJECT HISTORY MODAL */
.proj-history-list{max-height:420px;overflow-y:auto;}
.ph-entry{display:flex;align-items:flex-start;gap:12px;padding:11px 0;border-bottom:1px solid var(--border);}
.ph-entry:last-child{border-bottom:none;}
.ph-icon{font-size:15px;flex-shrink:0;}
.ph-body{flex:1;}.ph-text{font-size:13px;}.ph-meta{font-size:11px;color:var(--muted);margin-top:2px;}
.ph-time{font-size:10px;color:var(--muted2);white-space:nowrap;flex-shrink:0;margin-top:2px;}

/* TOAST */
.toast{position:fixed;bottom:24px;right:24px;z-index:300;background:var(--surface2);border:1px solid var(--border2);border-radius:3px;padding:12px 18px;font-size:13px;color:var(--text);animation:fadeUp .22s ease;display:flex;align-items:center;gap:10px;max-width:360px;box-shadow:0 4px 24px rgba(0,0,0,.3);transition:var(--tr);}
.toast-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.toast.success .toast-dot{background:var(--accent);}.toast.info .toast-dot{background:var(--github);}.toast.error .toast-dot{background:var(--danger);}.toast.warn .toast-dot{background:var(--warn);animation:pulse 1s infinite;}

/* RESPONSIVE */
.sidebar-toggle{display:none;background:none;border:1px solid var(--border2);color:var(--muted);font-family:'DM Mono',monospace;font-size:12px;padding:8px 12px;cursor:pointer;border-radius:2px;margin-right:8px;transition:var(--tr);align-items:center;gap:6px;}
.sidebar-toggle:hover{color:var(--accent);border-color:var(--accent);}
.sidebar-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:85;pointer-events:none;opacity:0;transition:opacity .2s ease;}
@media(max-width:768px){
  .sidebar-overlay{pointer-events:none;}
  body.sidebar-open .sidebar-overlay{pointer-events:auto;opacity:1;}
}
@media(min-width:769px){
  .sidebar-overlay{display:none;}
}
@media(max-width:900px){
  .topbar{padding:12px 16px;flex-wrap:wrap;gap:10px;}
  .topbar-left{flex:1;min-width:0;}
  .topbar-center{order:3;width:100%;justify-content:flex-start;}
  .topbar-right{order:2;flex-shrink:0;}
  .main-panel{padding:24px 18px;}
}
@media(max-width:768px){
  .sidebar-toggle{display:flex;}
  .sidebar-toggle-text{display:none;}
  .topbar-left{gap:8px;}
  .brand{font-size:17px;}
  .app-body{position:relative;}
  .sidebar{position:fixed;left:0;top:53px;width:260px;max-width:85vw;height:calc(100vh - 53px);z-index:90;transform:translateX(-100%);transition:transform .25s ease;box-shadow:4px 0 20px rgba(0,0,0,.25);}
  body.sidebar-open .sidebar{transform:translateX(0);}
  .main-panel{margin-left:0;padding:20px 16px;}
  .topbar{padding:10px 12px;gap:12px;}
  .nav-tab{padding:6px 10px;font-size:10px;}
  .top-btn-icon{display:flex;align-items:center;justify-content:center;}
  .top-btn .top-btn-text{display:none;}
  .top-btn{padding:8px;min-width:40px;}
  .sync-pill-text{display:none;}
  .sync-pill{padding:8px;min-width:40px;}
  .user-chip .uc-name{display:none;}
  .user-chip{padding:4px;border-radius:50%;}
  .uc-avatar{width:32px;height:32px;font-size:12px;}
  .panel-title{font-size:clamp(22px,5vw,32px);}
  .proj-header{flex-wrap:wrap;gap:8px;padding:12px 14px;}
  .proj-prog-wrap{order:3;width:100%;}
  .proj-actions{flex-shrink:0;}
  .task-row{padding:12px 14px;gap:10px;flex-wrap:wrap;}
  .task-date{width:100%;order:3;margin-top:2px;margin-left:26px;}
  .task-row-actions{opacity:1;}
  .panel-empty .panel-empty-text br{display:none;}
  .topbar .topbar-center{display:none;}
  .main-tabs{display:flex;width:100%;background:var(--surface);border-bottom:1px solid var(--border);padding:0 8px;gap:0;}
  .main-tabs .nav-tab{flex:1;justify-content:center;text-align:center;padding:12px 8px;font-size:12px;letter-spacing:.08em;border-bottom:3px solid transparent;}
  .main-tabs .nav-tab.active{border-bottom-color:var(--accent);background:transparent;}
}
@media(max-width:600px){
  #profile-screen{padding:24px 16px;}
  .profile-box{max-width:100%;}
  .profile-logo{font-size:28px;}
  .profile-tagline{font-size:11px;margin-bottom:28px;}
  .profile-card{padding:14px 16px;}
  .new-profile-row{flex-direction:column;}
  .np-btn{width:100%;}
  .topbar{padding:8px 10px;gap:8px;}
  .topbar-center{justify-content:flex-start;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;}
  .topbar-center::-webkit-scrollbar{display:none;}
  .nav-tab{padding:8px 12px;}
  .main-panel{padding:16px 12px;}
  .add-proj-bar{flex-direction:column;}
  .add-proj-btn{width:100%;}
  .project-card .proj-header{flex-wrap:wrap;}
  .proj-name-wrap{min-width:0;}
  .task-row{padding:10px 12px;}
  .modal{padding:20px 18px;max-height:85vh;}
  .modal h3{font-size:20px;}
  .modal-btns{justify-content:stretch;}
  .modal-cancel,.modal-confirm{flex:1;}
  .toast{left:12px;right:12px;bottom:12px;max-width:none;}
}
@media(max-width:480px){
  .topbar-right .theme-toggle{display:none;}
  .topbar{padding:8px;}
  .brand{font-size:16px;}
  .top-btn{padding:8px;min-width:36px;}
  .sync-pill{padding:6px;min-width:36px;}
  .stat-card{padding:14px 12px;}
  .stat-num{font-size:28px;}
  .bar-lbl{font-size:8px;}
  .history-filters{flex-direction:column;align-items:stretch;}
  .history-filters select,.history-filters input[type=date]{width:100%;}
}
@media(hover:none) and (pointer:coarse){
  .cat-btn,.nav-tab,.top-btn,.s-btn,.t-btn,.pj-btn,.task-check,.color-swatch{min-height:44px;min-width:44px;}
  .task-check{min-width:44px;}
  .task-row-actions .t-btn{padding:8px 10px;}
  .proj-actions .pj-btn{padding:6px 10px;}
}
</style>
</head>
<body>

<!-- PROFILE SCREEN -->
<div id="profile-screen">
  <div class="profile-box">
    <div class="profile-logo">My<em>.</em>Tasks</div>
    <div class="profile-tagline">Your personal workspace</div>
    <div class="section-lbl" id="profile-section-lbl">Who's working today?</div>
    <div class="profile-list" id="profile-list"></div>
    <div id="new-profile-section">
      <div class="divider"></div>
      <div class="section-lbl">Create your account</div>
      <div class="new-profile-row">
        <input class="np-input" id="np-input" type="text" placeholder="Enter your name‚Ä¶" maxlength="40"/>
        <button class="np-btn" onclick="createProfile()">Create</button>
      </div>
    </div>
    <div class="section-lbl" style="margin-top:4px">Data & Sync</div>
    <div class="status-cards">
      <div class="status-card"><div class="s-dot" id="ps-file-dot"></div><div class="s-text" id="ps-file-text">No local file linked.</div><button class="s-btn" id="ps-file-btn" onclick="linkFile()">Link File</button></div>
      <div class="status-card"><div class="s-dot" id="ps-gh-dot"></div><div class="s-text" id="ps-gh-text">GitHub Gist not connected.</div><button class="s-btn" id="ps-gh-btn" onclick="openGistModal()">Connect</button></div>
    </div>
    <div id="logout-row" class="logout-row" style="display:none">
      <button type="button" class="logout-btn" onclick="logout()">Log out</button>
    </div>
    <div class="profile-theme-row">
      <span>Appearance</span>
      <div class="theme-toggle"><button class="tt-btn active" id="dark-btn" onclick="setTheme('dark')">üåô</button><button class="tt-btn" id="light-btn" onclick="setTheme('light')">‚òÄÔ∏è</button></div>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div id="app">
  <div class="topbar">
    <div class="topbar-left">
      <button class="sidebar-toggle" id="sidebar-toggle" type="button" onclick="toggleSidebar()" aria-label="Open categories"><span aria-hidden="true">‚ò∞</span><span class="sidebar-toggle-text"> Categories</span></button>
      <div class="brand">My<em>.</em>Tasks</div>
    </div>
    <div class="topbar-center">
      <button class="nav-tab active" data-view="tasks" onclick="switchView('tasks',this)">Tasks</button>
      <button class="nav-tab" data-view="analytics" onclick="switchView('analytics',this)">Analytics</button>
      <button class="nav-tab" data-view="history" onclick="switchView('history',this)">History</button>
    </div>
    <div class="topbar-right">
      <button class="top-btn" onclick="saveAll()" title="Save"><span class="top-btn-icon" aria-hidden="true">üíæ</span><div class="dirty-dot" id="dirty-dot"></div><span class="top-btn-text">Save</span></button>
      <div class="sync-pill" id="sync-pill" onclick="openSyncPanel()" title="Gist sync"><div class="sync-dot" id="sync-dot"></div><span class="sync-pill-text" id="sync-label">Gist</span></div>
      <div class="theme-toggle"><button class="tt-btn active" id="app-dark-btn" onclick="setTheme('dark')">üåô</button><button class="tt-btn" id="app-light-btn" onclick="setTheme('light')">‚òÄÔ∏è</button></div>
      <div class="user-chip" onclick="goToProfiles()" title="Switch profile"><div class="uc-avatar" id="uc-avatar"></div><span class="uc-name" id="uc-name"></span></div>
    </div>
  </div>
  <div class="main-tabs" id="main-tabs">
    <button class="nav-tab active" data-view="tasks" onclick="switchView('tasks',this)">Tasks</button>
    <button class="nav-tab" data-view="analytics" onclick="switchView('analytics',this)">Analytics</button>
    <button class="nav-tab" data-view="history" onclick="switchView('history',this)">History</button>
  </div>
  <div class="app-body">
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()" aria-hidden="true"></div>
    <div class="sidebar" id="sidebar"></div>
    <div class="main-panel">
      <div id="view-tasks"><div id="tasks-content"></div></div>
      <div id="view-analytics" style="display:none">
        <div class="analytics-wrap">
          <div style="margin-bottom:26px"><div style="font-size:11px;letter-spacing:.26em;text-transform:uppercase;color:var(--accent);margin-bottom:6px">‚óÜ Insights</div><div style="font-family:'Playfair Display',serif;font-size:clamp(28px,3.5vw,42px);font-weight:700">Analytics</div></div>
          <div class="period-row"><button class="pill active" onclick="setPeriod('week',this)">This Week</button><button class="pill" onclick="setPeriod('month',this)">This Month</button><button class="pill" onclick="setPeriod('all',this)">All Time</button></div>
          <div class="stat-grid">
            <div class="stat-card"><div class="stat-num hi" id="a-total">0</div><div class="stat-lbl">Total Tasks</div></div>
            <div class="stat-card"><div class="stat-num" id="a-done">0</div><div class="stat-lbl">Completed</div></div>
            <div class="stat-card"><div class="stat-num" id="a-rate">0%</div><div class="stat-lbl">Rate</div></div>
            <div class="stat-card"><div class="stat-num" id="a-projs">0</div><div class="stat-lbl">Projects</div></div>
          </div>
          <div class="chart-card"><div class="chart-ttl" id="bar-ttl">Tasks per Day</div><div class="bar-chart-wrap" id="bar-chart"></div><div class="legend-row"><div class="legend-row-item"><div class="legend-sq" style="background:var(--accent);opacity:.85"></div>Completed</div><div class="legend-row-item"><div class="legend-sq" style="background:var(--border2)"></div>Pending</div></div></div>
          <div class="two-col">
            <div class="chart-card" style="margin-bottom:0"><div class="chart-ttl">By Category</div><div class="donut-wrap"><svg id="donut-svg" width="100" height="100" viewBox="0 0 100 100" style="flex-shrink:0"></svg><div class="donut-legend" id="donut-legend"></div></div></div>
            <div class="chart-card" style="margin-bottom:0"><div class="chart-ttl">Insights</div><div class="insight-row" id="insights"></div></div>
          </div>
          <div class="chart-card" style="margin-top:11px"><div class="chart-ttl">Project Breakdown</div><table class="proj-table"><thead><tr><th>Project</th><th>Category</th><th style="text-align:center">Tasks</th><th style="text-align:center">Done</th><th style="text-align:right">Rate</th></tr></thead><tbody id="proj-tbody"></tbody></table></div>
          <div class="chart-card"><div class="chart-ttl">Activity ‚Äî Last 5 Weeks</div><div class="heatmap-grid" id="heatmap"></div></div>
        </div>
      </div>
      <div id="view-history" style="display:none">
        <div class="history-wrap">
          <div style="margin-bottom:26px"><div style="font-size:11px;letter-spacing:.26em;text-transform:uppercase;color:var(--accent);margin-bottom:6px">‚óÜ Audit</div><div style="font-family:'Playfair Display',serif;font-size:clamp(28px,3.5vw,42px);font-weight:700">History</div></div>
          <div class="period-row" style="margin-bottom:16px"><button class="pill active" id="hmode-log" onclick="setHistoryMode('log',this)">Audit Log</button><button class="pill" id="hmode-snap" onclick="setHistoryMode('snapshots',this)">Daily Snapshots</button></div>
          <div class="history-filters">
            <select id="hf-type" onchange="renderHistory()"><option value="">All events</option><option value="completed">Completed</option><option value="deleted">Deleted</option><option value="created">Created</option><option value="edited">Edited</option><option value="reset">Daily Reset</option></select>
            <select id="hf-cat" onchange="renderHistory()"><option value="">All categories</option></select>
            <input type="date" id="hf-from" onchange="renderHistory()"/>
            <input type="date" id="hf-to" onchange="renderHistory()"/>
            <button class="history-clear" onclick="clearHistoryFilters()">Clear filters</button>
          </div>
          <div id="history-content"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- CAT MODAL -->
<div id="cat-modal" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeCatModal()">
  <div class="modal"><h3 id="cat-modal-title">New Category</h3><label>Name</label><input id="cat-name" type="text" placeholder="e.g. Work, Personal‚Ä¶" maxlength="40" onkeydown="if(event.key==='Enter')confirmCat()"/><label>Colour</label><div class="color-picker" id="color-picker"></div><div class="modal-btns"><button class="modal-cancel" onclick="closeCatModal()">Cancel</button><button class="modal-confirm" onclick="confirmCat()" id="cat-confirm-btn">Create</button></div></div>
</div>

<!-- GIST MODAL -->
<div id="gist-modal" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeGistModal()">
  <div class="modal"><h3>Connect GitHub Gist</h3><p class="modal-desc">Data syncs to a private Gist, accessible from any device.</p><div class="modal-note">1. Go to <a href="https://github.com/settings/tokens/new" target="_blank">github.com/settings/tokens/new</a><br>2. Set <strong>No expiration</strong>, tick <strong>gist</strong> scope only<br>3. Generate ‚Üí copy ‚Üí paste below</div><label>Personal Access Token</label><input id="gh-token" type="password" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx"/><label>Gist ID <span style="color:var(--muted2);text-transform:none;letter-spacing:0">(blank = create new)</span></label><input id="gh-gist-id" type="text" placeholder="leave blank to create a new Gist"/><div class="modal-btns"><button class="modal-cancel" onclick="closeGistModal()">Cancel</button><button class="modal-confirm gh-btn" onclick="connectGist()">Connect</button></div></div>
</div>

<!-- SLACK MODAL -->
<!-- SYNC PANEL -->
<div id="sync-modal" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeSyncModal()">
  <div class="modal"><h3>GitHub Gist Sync</h3><div id="sync-status-area"></div><div class="countdown-bar"><div class="countdown-fill" id="countdown-fill"></div></div><div class="sync-time" id="sync-time-label">Auto-sync every 30 minutes</div><div class="modal-btns" id="sync-modal-btns"></div></div>
</div>

<!-- DAILY RESET MODAL -->
<div id="reset-modal" class="modal-overlay" style="display:none">
  <div class="modal"><h3>üåÖ New Day</h3><p class="modal-desc">It's a new day! Yesterday's completed tasks are listed below. You can remove them and carry pending tasks forward.</p><div id="reset-modal-body"></div><div class="modal-btns" id="reset-modal-btns"></div></div>
</div>

<!-- PROJECT HISTORY MODAL -->
<div id="proj-history-modal" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeProjHistory()">
  <div class="modal"><h3 id="ph-title">Project History</h3><p class="modal-desc" id="ph-desc"></p><div class="proj-history-list" id="ph-list"></div><div class="modal-btns" style="margin-top:18px"><button class="modal-cancel" onclick="closeProjHistory()">Close</button></div></div>
</div>

<script>
const PALETTE=['#c8f54a','#7eb8f7','#f7c07e','#7ef7b1','#f77eb8','#b4a8f0','#f0c070','#7ef0f0','#ff9f7e','#c8a8f0'];
const DAY=86400000,AUTOSAVE_MS=30*60*1000;
let allData={},activeProfileId=null,activeCatId=null,period='week',historyMode='log';
let openProjects=new Set(),isDirty=false,selectedColor=PALETTE[0],editingCatId=null;
let fileHandle=null,ghToken='',ghGistId='';
let lastSyncAt=null,syncStatus='disconnected',autoSyncTimer=null,countdownTimer=null,countdownStart=null;

// UTILS
function uid(){return Math.random().toString(36).slice(2)+Date.now().toString(36);}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function sod(ts){const d=new Date(ts);d.setHours(0,0,0,0);return d.getTime();}
function fmtDate(ts){return new Date(ts).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});}
function fmtTime(ts){return new Date(ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});}
function fmtDT(ts){return fmtDate(ts)+' '+fmtTime(ts);}
function todayStr(){const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}

// THEME
function setTheme(t){document.documentElement.setAttribute('data-theme',t);localStorage.setItem('mytasks_theme',t);['','app-'].forEach(p=>{const db=document.getElementById(p+'dark-btn'),lb=document.getElementById(p+'light-btn');if(db)db.classList.toggle('active',t==='dark');if(lb)lb.classList.toggle('active',t==='light');});}
function loadTheme(){setTheme(localStorage.getItem('mytasks_theme')||'dark');}

// LOCAL STORAGE
function saveLocal(){localStorage.setItem('mytasks_all',JSON.stringify(allData));localStorage.setItem('mytasks_gh_token',ghToken);localStorage.setItem('mytasks_gh_gist',ghGistId);if(lastSyncAt)localStorage.setItem('mytasks_last_sync',String(lastSyncAt));}
function loadLocal(){ghToken=localStorage.getItem('mytasks_gh_token')||'';ghGistId=localStorage.getItem('mytasks_gh_gist')||'';const ls=localStorage.getItem('mytasks_last_sync');lastSyncAt=ls?parseInt(ls):null;allData={};}

// DATA INIT
async function initData(){
  allData={};
  if(fileHandle){try{const f=await fileHandle.getFile(),t=await f.text();if(t.trim())allData={...JSON.parse(t)};}catch(e){fileHandle=null;}}
  if(ghToken&&ghGistId){try{const g=await gistReq('GET','/gists/'+ghGistId),c=g.files['mytasks-data.json']?.content;if(c){allData={...allData,...JSON.parse(c)};lastSyncAt=Date.now();localStorage.setItem('mytasks_last_sync',String(lastSyncAt));}setSyncStatus('synced');}catch(e){setSyncStatus('error');toast('Could not reach Gist ‚Äî using local data.','error');}}
  renderProfileList();updateProfileScreenStatus();
}

// FILE
async function linkFile(){
  if(!window.showOpenFilePicker){toast('File System API requires Chrome or Edge.','error');return;}
  try{const opts={types:[{description:'Task Data',accept:{'application/json':['.json']}}],suggestedName:'mytasks-data.json'};try{[fileHandle]=await window.showOpenFilePicker({...opts,multiple:false});}catch{[fileHandle]=[await window.showSaveFilePicker(opts)];}try{const f=await fileHandle.getFile(),t=await f.text();if(t.trim())allData={...allData,...JSON.parse(t)};}catch(e){}if(ghToken&&ghGistId)await pullFromGist(false);saveLocal();updateProfileScreenStatus();renderProfileList();toast('File linked: '+fileHandle.name,'success');}catch(e){if(e.name!=='AbortError')toast('Could not link file.','error');}
}
async function saveToFile(){if(!fileHandle)return;try{const w=await fileHandle.createWritable();await w.write(JSON.stringify(allData,null,2));await w.close();}catch(e){}}
let _fsTimer;
function debouncedFileSave(){if(!fileHandle)return;clearTimeout(_fsTimer);_fsTimer=setTimeout(async()=>{await saveToFile();isDirty=false;updateDirtyDot();},1500);}

// GIST
async function gistReq(method,path,body){const res=await fetch('https://api.github.com'+path,{method,headers:{'Authorization':'token '+ghToken,'Accept':'application/vnd.github.v3+json','Content-Type':'application/json'},body:body?JSON.stringify(body):undefined});if(!res.ok)throw new Error(res.status);return res.json();}
async function connectGist(){const token=document.getElementById('gh-token').value.trim(),gistId=document.getElementById('gh-gist-id').value.trim();if(!token){toast('Enter a token first.','error');return;}ghToken=token;setSyncStatus('syncing');try{let gist;if(gistId){gist=await gistReq('GET','/gists/'+gistId);const c=gist.files['mytasks-data.json']?.content;if(c)allData={...allData,...JSON.parse(c)};ghGistId=gistId;}else{gist=await gistReq('POST','/gists',{description:'MyTasks data',public:false,files:{'mytasks-data.json':{content:JSON.stringify(allData,null,2)}}});ghGistId=gist.id;}lastSyncAt=Date.now();setSyncStatus('synced');saveLocal();if(fileHandle)debouncedFileSave();closeGistModal();updateProfileScreenStatus();renderProfileList();startAutoSync();toast('Connected! Gist ID: '+ghGistId,'info');}catch(e){setSyncStatus('error');toast('Connection failed. Check token.','error');}}
async function pullFromGist(showToast=true){if(!ghToken||!ghGistId)return false;if(showToast)setSyncStatus('syncing');try{const g=await gistReq('GET','/gists/'+ghGistId),c=g.files['mytasks-data.json']?.content;if(c){allData={...allData,...JSON.parse(c)};if(fileHandle)debouncedFileSave();saveLocal();renderProfileList();if(activeProfileId&&allData[activeProfileId]){renderSidebar();renderTasksContent();}}lastSyncAt=Date.now();setSyncStatus('synced');if(showToast)toast('Pulled latest from Gist','info');return true;}catch(e){setSyncStatus('error');if(showToast)toast('Pull failed.','error');return false;}}
async function pushToGist(){if(!ghToken||!ghGistId)return false;setSyncStatus('syncing');try{await gistReq('PATCH','/gists/'+ghGistId,{files:{'mytasks-data.json':{content:JSON.stringify(allData,null,2)}}});lastSyncAt=Date.now();setSyncStatus('synced');if(fileHandle)debouncedFileSave();saveLocal();return true;}catch(e){setSyncStatus('error');return false;}}
async function syncNow(){const ok=await pushToGist();toast(ok?'Synced to GitHub Gist':'Sync failed.',ok?'info':'error');if(ok)resetCountdown();}
function disconnectGist(){if(!confirm('Disconnect GitHub Gist?'))return;ghToken='';ghGistId='';lastSyncAt=null;syncStatus='disconnected';saveLocal();clearInterval(autoSyncTimer);clearInterval(countdownTimer);updateSyncPill();updateProfileScreenStatus();closeSyncModal();toast('Disconnected.','info');}
function startAutoSync(){clearInterval(autoSyncTimer);clearInterval(countdownTimer);if(!ghToken||!ghGistId)return;countdownStart=Date.now();autoSyncTimer=setInterval(async()=>{await syncNow();countdownStart=Date.now();},AUTOSAVE_MS);countdownTimer=setInterval(()=>updateCountdownBar(),1000);}
function resetCountdown(){countdownStart=Date.now();updateCountdownBar();}
function updateCountdownBar(){const fill=document.getElementById('countdown-fill'),lbl=document.getElementById('sync-time-label');if(!fill||!countdownStart)return;const elapsed=Date.now()-countdownStart,remaining=Math.max(0,AUTOSAVE_MS-elapsed);fill.style.width=((AUTOSAVE_MS-remaining)/AUTOSAVE_MS*100)+'%';const m=Math.floor(remaining/60000),s=Math.floor((remaining%60000)/1000);if(lbl)lbl.textContent=`Next auto-sync in ${m}m ${String(s).padStart(2,'0')}s`;}
function setSyncStatus(s){syncStatus=s;updateSyncPill();}
function updateSyncPill(){const dot=document.getElementById('sync-dot'),lbl=document.getElementById('sync-label');if(!dot)return;dot.className='sync-dot';if(syncStatus==='synced'){dot.classList.add('synced');lbl.textContent='Synced';}else if(syncStatus==='syncing'){dot.classList.add('syncing');lbl.textContent='Syncing‚Ä¶';}else if(syncStatus==='error'){dot.classList.add('error');lbl.textContent='Error';}else lbl.textContent='Gist';}
function openSyncPanel(){const area=document.getElementById('sync-status-area'),btns=document.getElementById('sync-modal-btns');if(!ghToken||!ghGistId){area.innerHTML=`<div class="sync-info-row"><div class="s-dot err"></div><div>Not connected.</div></div>`;btns.innerHTML=`<button class="modal-cancel" onclick="closeSyncModal()">Close</button><button class="modal-confirm gh-btn" onclick="closeSyncModal();openGistModal()">Connect Gist</button>`;}else{const ls=lastSyncAt?`Last synced ${fmtTime(lastSyncAt)}`:'Never synced';const fst=fileHandle?`<div style="font-size:12px;color:var(--muted);margin-top:3px">File: ${fileHandle.name}</div>`:'';area.innerHTML=`<div class="sync-info-row"><div class="s-dot ${syncStatus==='synced'?'gh':syncStatus==='error'?'err':'on'}"></div><div><div style="font-size:13px;margin-bottom:2px">Gist: <span style="color:var(--github)">${ghGistId.slice(0,16)}‚Ä¶</span></div><div style="font-size:12px;color:var(--muted)">${ls}</div>${fst}</div></div>`;btns.innerHTML=`<button class="modal-cancel" style="color:var(--danger);border-color:var(--danger)" onclick="disconnectGist()">Disconnect</button><button class="modal-cancel" onclick="closeSyncModal()">Close</button><button class="modal-confirm" onclick="closeSyncModal();pullFromGist()">Pull</button><button class="modal-confirm gh-btn" onclick="closeSyncModal();syncNow()">Sync Now</button>`;}updateCountdownBar();document.getElementById('sync-modal').style.display='flex';}
function closeSyncModal(){document.getElementById('sync-modal').style.display='none';}
function openGistModal(){document.getElementById('gh-token').value=ghToken;document.getElementById('gh-gist-id').value=ghGistId;document.getElementById('gist-modal').style.display='flex';setTimeout(()=>document.getElementById('gh-token').focus(),80);}
function closeGistModal(){document.getElementById('gist-modal').style.display='none';}

// SLACK
async function saveAll(){
  markDirty();if(fileHandle){await saveToFile();isDirty=false;updateDirtyDot();}
  if(ghToken&&ghGistId){const ok=await pushToGist();if(ok)resetCountdown();toast(ok?'Saved & synced to Gist':'Saved locally. Sync failed.',ok?'success':'error');}
  else toast('Saved.','success');
}

// AUDIT LOG
function auditLog(){const p=DB();if(!p.auditLog)p.auditLog=[];return p.auditLog;}
function logEvent(type,taskText,projName,catName,extra={}){
  const p=DB();if(!p)return;if(!p.auditLog)p.auditLog=[];
  p.auditLog.unshift({id:uid(),ts:Date.now(),type,taskText:taskText||'',projName:projName||'',catName:catName||'',profileName:p.name,...extra});
  if(p.auditLog.length>2000)p.auditLog.length=2000;
}
function getCtx(t){const proj=projById(t.projId),cat=proj?catById(proj.catId):null;return{projName:proj?.name||'',catName:cat?.name||''};}

// SNAPSHOTS
function takeSnapshot(){
  const p=DB();if(!p)return;if(!p.snapshots)p.snapshots=[];
  const today=todayStr();p.snapshots=p.snapshots.filter(s=>s.date!==today);
  p.snapshots.unshift({date:today,ts:Date.now(),tasks:allTasks().map(t=>{const ctx=getCtx(t);return{id:t.id,text:t.text,done:t.done,projName:ctx.projName,catName:ctx.catName,ts:t.ts};})});
  if(p.snapshots.length>90)p.snapshots.length=90;
}

// DAILY RESET
function checkDailyReset(){
  const p=DB();if(!p)return;const today=todayStr();
  if(p.lastResetDay===today)return;
  const done=allTasks().filter(t=>t.done);
  if(!done.length){p.lastResetDay=today;markDirty();return;}
  takeSnapshot();showResetModal(done,today);
}
function showResetModal(doneTasks,today){
  const pending=allTasks().filter(t=>!t.done);
  document.getElementById('reset-modal-body').innerHTML=`
    <div class="reset-task-list">${doneTasks.map(t=>{const ctx=getCtx(t);return`<div class="reset-task-row"><div class="rt-icon">‚úÖ</div><div style="flex:1;min-width:0"><div style="font-size:13px;color:var(--muted);text-decoration:line-through">${esc(t.text)}</div><div style="font-size:11px;color:var(--muted2)">${esc(ctx.catName)} ‚Ä∫ ${esc(ctx.projName)}</div></div></div>`;}).join('')}</div>
    <div style="font-size:13px;color:var(--text);margin-bottom:16px"><strong style="color:var(--accent)">${pending.length}</strong> pending task${pending.length!==1?'s':''} will carry forward to today.</div>`;
  document.getElementById('reset-modal-btns').innerHTML=`<button class="modal-cancel" onclick="dismissReset('${today}')">Keep everything (skip)</button><button class="modal-confirm" onclick="doReset('${today}')">Remove completed & start fresh</button>`;
  document.getElementById('reset-modal').style.display='flex';
}
function doReset(today){
  const p=DB(),done=allTasks().filter(t=>t.done);
  done.forEach(t=>{const ctx=getCtx(t);logEvent('reset',t.text,ctx.projName,ctx.catName,{detail:'Removed at daily reset'});});
  logEvent('reset','','','',{detail:`Daily reset: ${done.length} tasks removed, ${allTasks().filter(t=>!t.done).length} carried forward`});
  p.tasks=p.tasks.filter(t=>!t.done);p.lastResetDay=today;
  markDirty();document.getElementById('reset-modal').style.display='none';
  renderSidebar();renderTasksContent();toast(`${done.length} completed tasks removed for the new day.`,'success');
}
function dismissReset(today){const p=DB();p.lastResetDay=today;markDirty();document.getElementById('reset-modal').style.display='none';}
function scheduleMidnightCheck(){const now=new Date(),midnight=new Date(now.getFullYear(),now.getMonth(),now.getDate()+1,0,0,5);setTimeout(()=>{if(activeProfileId&&allData[activeProfileId]){checkDailyReset();}scheduleMidnightCheck();},midnight.getTime()-now.getTime());}

// DIRTY/SAVE
function markDirty(){isDirty=true;updateDirtyDot();saveLocal();if(fileHandle)debouncedFileSave();}
function updateDirtyDot(){const d=document.getElementById('dirty-dot');if(d)d.className='dirty-dot'+(isDirty?' on':'');}
function updateProfileScreenStatus(){
  const fd=document.getElementById('ps-file-dot'),ft=document.getElementById('ps-file-text');
  const gd=document.getElementById('ps-gh-dot'),gt=document.getElementById('ps-gh-text'),gb=document.getElementById('ps-gh-btn');
  if(!fd)return;
  if(fileHandle){fd.className='s-dot on';ft.textContent='Local file: '+fileHandle.name;}else{fd.className='s-dot';ft.textContent='No local file linked.';}
  if(ghToken&&ghGistId){gd.className='s-dot gh';gt.textContent='Gist connected ‚Äî auto-sync every 30 min';gb.textContent='Manage';gb.onclick=openSyncPanel;}else{gd.className='s-dot';gt.textContent='GitHub Gist not connected.';gb.textContent='Connect';gb.onclick=openGistModal;}
  if(!window.showOpenFilePicker){ft.textContent='File System API: Chrome/Edge only.';const b=document.getElementById('ps-file-btn');if(b)b.style.display='none';}
}

// PROFILES
function defaultProfile(name){const color=PALETTE[Math.floor(Math.random()*PALETTE.length)];return{name,color,categories:[{id:uid(),name:'Work',color:'#7eb8f7'},{id:uid(),name:'Personal',color:'#f7c07e'},{id:uid(),name:'Health',color:'#7ef7b1'}],projects:[],tasks:[],auditLog:[],snapshots:[],lastResetDay:null};}
function renderProfileList(){const list=document.getElementById('profile-list');const entries=Object.entries(allData);const newSection=document.getElementById('new-profile-section');const sectionLbl=document.getElementById('profile-section-lbl');const logoutRow=document.getElementById('logout-row');if(newSection)newSection.style.display=entries.length>=1?'none':'block';if(sectionLbl)sectionLbl.textContent=entries.length>=1?'Your workspace':'Who\'s working today?';if(logoutRow)logoutRow.style.display=entries.length>=1?'block':'none';if(!entries.length){list.innerHTML=`<div style="font-size:14px;color:var(--muted2);padding:10px 4px">Create your account below to get started.</div>`;return;}list.innerHTML=entries.map(([id,p])=>{const tasks=p.tasks||[],done=tasks.filter(t=>t.done).length,ini=p.name.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();return`<div class="profile-card" onclick="enterProfile('${id}')"><div class="pc-left"><div class="p-avatar" style="background:${p.color}">${ini}</div><div><div class="p-name">${esc(p.name)}</div><div class="p-meta">${tasks.length} tasks ¬∑ ${done} done</div></div></div><div class="p-arrow">‚ñ∂</div></div>`;}).join('');}
function logout(){if(!confirm('Log out? This will unlink your file and clear locally saved data. Your Gist connection will remain.'))return;fileHandle=null;localStorage.removeItem('mytasks_all');allData={};activeProfileId=null;closeSidebar();if(ghToken&&ghGistId){clearInterval(autoSyncTimer);clearInterval(countdownTimer);}document.getElementById('app').style.display='none';document.getElementById('profile-screen').style.display='flex';updateProfileScreenStatus();renderProfileList();toast('Logged out. File unlinked and local data cleared.','info');}
function createProfile(){if(Object.keys(allData).length>=1){toast('Only one user is allowed.', 'info');return;}const inp=document.getElementById('np-input'),name=inp.value.trim();if(!name)return;const id=uid();allData[id]=defaultProfile(name);markDirty();inp.value='';renderProfileList();enterProfile(id);}
document.getElementById('np-input').addEventListener('keydown',e=>{if(e.key==='Enter')createProfile();});
function enterProfile(id){
  activeProfileId=id;activeCatId=null;openProjects=new Set();
  document.getElementById('profile-screen').style.display='none';document.getElementById('app').style.display='flex';
  const p=DB(),ini=p.name.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
  document.getElementById('uc-avatar').textContent=ini;document.getElementById('uc-avatar').style.background=p.color;document.getElementById('uc-name').textContent=p.name;
  if(!p.auditLog)p.auditLog=[];if(!p.snapshots)p.snapshots=[];
  updateSyncPill();renderSidebar();renderTasksContent();checkDailyReset();scheduleMidnightCheck();populateHistoryCatFilter();
}
function goToProfiles(){activeProfileId=null;closeSidebar();document.getElementById('app').style.display='none';document.getElementById('profile-screen').style.display='flex';document.querySelectorAll('.nav-tab').forEach(b=>b.classList.toggle('active',b.getAttribute('data-view')==='tasks'));['view-tasks','view-analytics','view-history'].forEach((v,i)=>document.getElementById(v).style.display=i===0?'block':'none');updateProfileScreenStatus();renderProfileList();}
function toggleSidebar(){document.body.classList.toggle('sidebar-open');document.getElementById('sidebar-overlay').setAttribute('aria-hidden',document.body.classList.contains('sidebar-open')?'false':'true');}
function closeSidebar(){document.body.classList.remove('sidebar-open');document.getElementById('sidebar-overlay').setAttribute('aria-hidden','true');}

// DB
function DB(){return allData[activeProfileId];}
function cats(){return DB().categories||[];}function projs(){return DB().projects||[];}function allTasks(){return DB().tasks||[];}
function catById(id){return cats().find(c=>c.id===id);}function projById(id){return projs().find(p=>p.id===id);}
function tasksByProj(id){return allTasks().filter(t=>t.projId===id);}
function tasksByCat(id){const pids=projs().filter(p=>p.catId===id).map(p=>p.id);return allTasks().filter(t=>pids.includes(t.projId));}

// SIDEBAR
function renderSidebar(){const sb=document.getElementById('sidebar');sb.innerHTML=`<div class="sb-lbl">Categories</div>`+cats().map(cat=>{const t=tasksByCat(cat.id).length,d=tasksByCat(cat.id).filter(x=>x.done).length;return`<button class="cat-btn ${cat.id===activeCatId?'active':''}" onclick="selectCat('${cat.id}')"><div class="cb-left"><div class="cat-dot" style="background:${cat.color};color:${cat.color}"></div><span class="cb-name">${esc(cat.name)}</span></div><div class="cb-actions"><span class="cb-action" onclick="event.stopPropagation();editCat('${cat.id}')" title="Edit">‚úé</span><span class="cb-action del" onclick="event.stopPropagation();deleteCat('${cat.id}')" title="Delete">√ó</span></div><div class="cat-badge">${d}/${t}</div></button>`;}).join('')+`<div class="sb-div"></div><button class="add-cat-btn" onclick="openCatModal()">+ New category</button>`;}
function selectCat(id){activeCatId=id;openProjects=new Set();closeSidebar();renderSidebar();renderTasksContent();}

// CATEGORY CRUD
function openCatModal(){editingCatId=null;selectedColor=PALETTE[0];document.getElementById('cat-modal-title').textContent='New Category';document.getElementById('cat-confirm-btn').textContent='Create';document.getElementById('cat-name').value='';buildColorPicker(null);document.getElementById('cat-modal').style.display='flex';setTimeout(()=>document.getElementById('cat-name').focus(),80);}
function editCat(id){editingCatId=id;const cat=catById(id);if(!cat)return;selectedColor=cat.color;document.getElementById('cat-modal-title').textContent='Edit Category';document.getElementById('cat-confirm-btn').textContent='Save';document.getElementById('cat-name').value=cat.name;buildColorPicker(cat.color);document.getElementById('cat-modal').style.display='flex';setTimeout(()=>document.getElementById('cat-name').focus(),80);}
function buildColorPicker(current){const colors=[...PALETTE,...(current&&!PALETTE.includes(current)?[current]:[])];document.getElementById('color-picker').innerHTML=colors.map(c=>`<div class="color-swatch ${c===selectedColor?'selected':''}" style="background:${c}" onclick="pickColor('${c}',this)"></div>`).join('');}
function closeCatModal(){document.getElementById('cat-modal').style.display='none';editingCatId=null;}
function pickColor(c,el){selectedColor=c;document.querySelectorAll('.color-swatch').forEach(s=>s.classList.remove('selected'));el.classList.add('selected');}
function confirmCat(){const name=document.getElementById('cat-name').value.trim();if(!name)return;if(editingCatId){const cat=catById(editingCatId);if(cat){const old=cat.name;cat.name=name;cat.color=selectedColor;logEvent('edited','',name,name,{detail:`Renamed from "${old}" to "${name}"`});}}else{const id=uid();DB().categories.push({id,name,color:selectedColor});logEvent('created','',name,name,{detail:`Category "${name}" created`});}closeCatModal();markDirty();renderSidebar();populateHistoryCatFilter();if(editingCatId&&activeCatId===editingCatId)renderTasksContent();if(!editingCatId)selectCat(DB().categories[DB().categories.length-1].id);}
function deleteCat(id){const cat=catById(id);if(!cat)return;const pc=projs().filter(p=>p.catId===id).length;if(!confirm(`Delete "${cat.name}"?${pc>0?` This will also delete ${pc} project(s) and all their tasks.`:''}`))return;const pids=projs().filter(p=>p.catId===id).map(p=>p.id);DB().tasks.filter(t=>pids.includes(t.projId)).forEach(t=>logEvent('deleted',t.text,'',cat.name,{detail:'Deleted with category'}));logEvent('deleted','','',cat.name,{detail:`Category "${cat.name}" deleted`});DB().tasks=DB().tasks.filter(t=>!pids.includes(t.projId));DB().projects=DB().projects.filter(p=>p.catId!==id);DB().categories=DB().categories.filter(c=>c.id!==id);if(activeCatId===id)activeCatId=null;markDirty();renderSidebar();renderTasksContent();populateHistoryCatFilter();}

// TASKS PANEL
function renderTasksContent(){const el=document.getElementById('tasks-content');if(!activeCatId){el.innerHTML=`<div class="panel-empty"><div class="panel-empty-icon">‚óà</div><div class="panel-empty-text">Select a category<br>to view projects and tasks.</div></div>`;return;}const cat=catById(activeCatId);if(!cat)return;const catProjs=projs().filter(p=>p.catId===activeCatId),total=tasksByCat(activeCatId).length,done=tasksByCat(activeCatId).filter(t=>t.done).length;el.innerHTML=`<div class="panel-header"><div><div class="panel-eyebrow" style="color:${cat.color}">‚óÜ ${esc(cat.name)}</div><div class="panel-title">${esc(cat.name)}</div><div class="panel-sub" id="panel-sub">${catProjs.length} project${catProjs.length!==1?'s':''} ¬∑ ${done}/${total} tasks done</div></div></div><div class="add-proj-bar"><input class="add-proj-input" id="new-proj-input" type="text" placeholder="New project name‚Ä¶" maxlength="60" onkeydown="if(event.key==='Enter')addProject()"/><button class="add-proj-btn" onclick="addProject()">+ Add</button></div>${!catProjs.length?`<div style="padding:40px 0;text-align:center;color:var(--muted2);font-size:14px">No projects yet ‚Äî add one above.</div>`:catProjs.map(p=>renderProjCard(p)).join('')}`;}

// PROJECT CRUD
function renderProjCard(proj){
  const allT=tasksByProj(proj.id),pending=allT.filter(t=>!t.done),done=allT.filter(t=>t.done);
  const pct=allT.length?Math.round(done.length/allT.length*100):0,isOpen=openProjects.has(proj.id),cat=catById(proj.catId);
  const taskRow=t=>`<div class="task-row ${t.done?'done-row':''}" id="tr-${t.id}"><div class="task-check" onclick="toggleTask('${t.id}')"><span class="task-checkmark">‚úì</span></div><div class="task-text-wrap"><span class="task-text" id="tt-${t.id}">${esc(t.text)}</span></div><div class="task-date">${fmtDate(t.ts)}</div><div class="task-row-actions"><button class="t-btn" onclick="startEditTask('${t.id}')" title="Edit">‚úé</button><button class="t-btn del" onclick="deleteTask('${t.id}')" title="Delete">√ó</button></div></div>`;
  let body='';
  if(isOpen){body=`<div class="proj-body">${!allT.length?`<div class="proj-empty">No tasks yet ‚Äî add one below.</div>`:''}${pending.map(taskRow).join('')}${done.length?`<div class="done-divider">‚úì Completed (${done.length})</div>${done.map(taskRow).join('')}`:''}  <div class="add-task-row"><input class="task-inline-input" id="ti-${proj.id}" type="text" placeholder="Add a task‚Ä¶" maxlength="120" onkeydown="if(event.key==='Enter')addTask('${proj.id}')"/><button class="task-inline-add" onclick="addTask('${proj.id}')">Add</button></div></div>`;}
  return`<div class="project-card ${isOpen?'open':''}" id="pc-${proj.id}"><div class="proj-header"><span class="proj-chevron" onclick="toggleProj('${proj.id}')">‚ñ∂</span><div class="proj-name-wrap" ondblclick="startEditProj('${proj.id}')"><span class="proj-name" id="pn-${proj.id}">${esc(proj.name)}</span></div><div class="proj-prog-wrap"><div class="proj-prog-bar"><div class="proj-prog-fill" id="ppf-${proj.id}" style="width:${pct}%;background:${cat?.color||'var(--accent)'}"></div></div><div class="proj-pct" id="ppp-${proj.id}">${pct}%</div></div><div class="proj-actions"><button class="pj-btn hist" onclick="openProjHistory('${proj.id}')" title="History">üïê</button><button class="pj-btn" onclick="startEditProj('${proj.id}')" title="Edit">‚úé</button><button class="pj-btn del" onclick="deleteProj(event,'${proj.id}')" title="Delete">√ó</button></div></div>${body}</div>`;
}
function toggleProj(id){if(openProjects.has(id))openProjects.delete(id);else openProjects.add(id);const card=document.getElementById('pc-'+id),proj=projById(id);if(card&&proj){const d=document.createElement('div');d.innerHTML=renderProjCard(proj);card.replaceWith(d.firstElementChild);}renderSidebar();}
function addProject(){const inp=document.getElementById('new-proj-input'),name=inp.value.trim();if(!name||!activeCatId)return;const id=uid(),cat=catById(activeCatId);DB().projects.push({id,catId:activeCatId,name});openProjects.add(id);logEvent('created','',name,cat?.name||'',{detail:`Project "${name}" created`});markDirty();renderSidebar();renderTasksContent();}
function startEditProj(id){const span=document.getElementById('pn-'+id);if(!span)return;const proj=projById(id);if(!proj)return;const input=document.createElement('input');input.className='proj-name-input';input.value=proj.name;input.maxLength=60;span.replaceWith(input);input.focus();input.select();const commit=()=>{const v=input.value.trim(),old=proj.name;if(v&&v!==proj.name){proj.name=v;const cat=catById(proj.catId);logEvent('edited','',v,cat?.name||'',{detail:`Project renamed from "${old}" to "${v}"`});markDirty();}const s=document.createElement('span');s.className='proj-name';s.id='pn-'+id;s.textContent=proj.name;input.replaceWith(s);renderSidebar();};input.addEventListener('blur',commit);input.addEventListener('keydown',e=>{if(e.key==='Enter')commit();if(e.key==='Escape'){const s=document.createElement('span');s.className='proj-name';s.id='pn-'+id;s.textContent=proj.name;input.replaceWith(s);}});}
function deleteProj(e,id){e.stopPropagation();const proj=projById(id);if(!proj)return;if(!confirm(`Delete "${proj.name}" and all its tasks?`))return;const cat=catById(proj.catId);tasksByProj(id).forEach(t=>logEvent('deleted',t.text,proj.name,cat?.name||'',{detail:'Deleted with project'}));logEvent('deleted','',proj.name,cat?.name||'',{detail:`Project "${proj.name}" deleted`});DB().projects=DB().projects.filter(p=>p.id!==id);DB().tasks=DB().tasks.filter(t=>t.projId!==id);openProjects.delete(id);markDirty();renderSidebar();renderTasksContent();}

// TASK CRUD
function addTask(projId){const inp=document.getElementById('ti-'+projId);if(!inp)return;const text=inp.value.trim();if(!text)return;const proj=projById(projId),cat=proj?catById(proj.catId):null;DB().tasks.push({id:uid(),projId,text,done:false,ts:Date.now()});logEvent('created',text,proj?.name||'',cat?.name||'');markDirty();renderSidebar();renderTasksContent();}
function startEditTask(taskId){const span=document.getElementById('tt-'+taskId);if(!span)return;const t=DB().tasks.find(t=>t.id===taskId);if(!t)return;const input=document.createElement('input');input.className='task-edit-input';input.value=t.text;input.maxLength=120;span.replaceWith(input);input.focus();input.select();const commit=()=>{const v=input.value.trim(),old=t.text;if(v&&v!==t.text){t.text=v;const ctx=getCtx(t);logEvent('edited',v,ctx.projName,ctx.catName,{detail:`Edited from "${old}"`});markDirty();}const s=document.createElement('span');s.className='task-text';s.id='tt-'+taskId;s.textContent=t.text;input.replaceWith(s);};input.addEventListener('blur',commit);input.addEventListener('keydown',e=>{if(e.key==='Enter')commit();if(e.key==='Escape'){const s=document.createElement('span');s.className='task-text';s.id='tt-'+taskId;s.textContent=t.text;input.replaceWith(s);}});}
function toggleTask(taskId){const t=DB().tasks.find(t=>t.id===taskId);if(!t)return;t.done=!t.done;const ctx=getCtx(t);logEvent(t.done?'completed':'uncompleted',t.text,ctx.projName,ctx.catName);markDirty();const proj=projById(t.projId);if(proj){const card=document.getElementById('pc-'+proj.id);if(card&&openProjects.has(proj.id)){const d=document.createElement('div');d.innerHTML=renderProjCard(proj);card.replaceWith(d.firstElementChild);}}renderSidebar();const sub=document.getElementById('panel-sub');if(sub&&activeCatId){const tot=tasksByCat(activeCatId).length,dn=tasksByCat(activeCatId).filter(t=>t.done).length,cp=projs().filter(p=>p.catId===activeCatId);sub.textContent=`${cp.length} project${cp.length!==1?'s':''} ¬∑ ${dn}/${tot} tasks done`;}}
function deleteTask(taskId){const t=DB().tasks.find(t=>t.id===taskId);if(t){const ctx=getCtx(t);logEvent('deleted',t.text,ctx.projName,ctx.catName);}DB().tasks=DB().tasks.filter(t=>t.id!==taskId);markDirty();renderSidebar();renderTasksContent();}

// PROJECT HISTORY MODAL
function openProjHistory(projId){const proj=projById(projId);if(!proj)return;const cat=catById(proj.catId);const entries=(DB().auditLog||[]).filter(e=>e.projName===proj.name);document.getElementById('ph-title').textContent=proj.name+' ‚Äî History';document.getElementById('ph-desc').textContent=(cat?cat.name+' ‚Ä∫ ':'')+proj.name+' ¬∑ '+entries.length+' events';const icons={completed:'‚úÖ',deleted:'üóë',created:'‚ú®',edited:'‚úèÔ∏è',reset:'üîÑ',uncompleted:'‚Ü©'};const colors={completed:'var(--accent)',deleted:'var(--danger)',created:'var(--github)',edited:'var(--warn)',reset:'var(--muted)',uncompleted:'var(--muted)'};document.getElementById('ph-list').innerHTML=!entries.length?`<div style="padding:20px 0;font-size:13px;color:var(--muted2);text-align:center">No history yet for this project.</div>`:entries.map(e=>`<div class="ph-entry"><div class="ph-icon">${icons[e.type]||'¬∑'}</div><div class="ph-body"><div class="ph-text" style="color:${colors[e.type]||'var(--text)'}">${esc(e.taskText||e.detail||e.type)}</div><div class="ph-meta">${e.type.toUpperCase()}${e.detail&&e.taskText?' ¬∑ '+esc(e.detail):''}</div></div><div class="ph-time">${fmtDT(e.ts)}</div></div>`).join('');document.getElementById('proj-history-modal').style.display='flex';}
function closeProjHistory(){document.getElementById('proj-history-modal').style.display='none';}

// HISTORY VIEW
function setHistoryMode(mode,btn){historyMode=mode;document.querySelectorAll('#view-history .period-row .pill').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderHistory();}
function populateHistoryCatFilter(){const sel=document.getElementById('hf-cat');if(!sel||!activeProfileId)return;const cur=sel.value;sel.innerHTML='<option value="">All categories</option>'+cats().map(c=>`<option value="${esc(c.name)}">${esc(c.name)}</option>`).join('');sel.value=cur;}
function clearHistoryFilters(){document.getElementById('hf-type').value='';document.getElementById('hf-cat').value='';document.getElementById('hf-from').value='';document.getElementById('hf-to').value='';renderHistory();}
function renderHistory(){
  const el=document.getElementById('history-content');if(!el||!activeProfileId)return;
  if(historyMode==='snapshots'){renderSnapshots(el);return;}
  const type=document.getElementById('hf-type').value,cat=document.getElementById('hf-cat').value,from=document.getElementById('hf-from').value,to=document.getElementById('hf-to').value;
  let entries=[...(DB().auditLog||[])];
  if(type)entries=entries.filter(e=>e.type===type||(type==='completed'&&e.type==='uncompleted'));
  if(cat)entries=entries.filter(e=>e.catName===cat);
  if(from)entries=entries.filter(e=>e.ts>=new Date(from).getTime());
  if(to)entries=entries.filter(e=>e.ts<=new Date(to).getTime()+DAY);
  if(!entries.length){el.innerHTML=`<div style="padding:40px 0;text-align:center;font-size:14px;color:var(--muted2)">No history entries match your filters.</div>`;return;}
  const icons={completed:'‚úÖ',uncompleted:'‚Ü©',deleted:'üóë',created:'‚ú®',edited:'‚úèÔ∏è',reset:'üîÑ'};
  const colors={completed:'var(--accent)',uncompleted:'var(--muted)',deleted:'var(--danger)',created:'var(--github)',edited:'var(--warn)',reset:'var(--muted)'};
  const tagBg={completed:'rgba(200,245,74,.12)',deleted:'rgba(255,89,89,.12)',created:'rgba(126,184,247,.12)',edited:'rgba(247,192,126,.12)',reset:'rgba(100,100,100,.12)',uncompleted:'rgba(100,100,100,.12)'};
  el.innerHTML=`<div class="history-list">`+entries.map(e=>`<div class="history-entry"><div class="he-icon">${icons[e.type]||'¬∑'}</div><div class="he-body"><div class="he-action" style="color:${colors[e.type]||'var(--text)'}"><span class="he-tag" style="background:${tagBg[e.type]||'transparent'};color:${colors[e.type]||'var(--muted)'}">${e.type.toUpperCase()}</span>${esc(e.taskText||e.detail||'')}</div><div class="he-meta">${[e.catName&&esc(e.catName),e.projName&&esc(e.projName),e.detail&&e.taskText?esc(e.detail):''].filter(Boolean).join(' ‚Ä∫ ')}</div></div><div class="he-time">${fmtDT(e.ts)}</div></div>`).join('')+`</div>`;
}
function renderSnapshots(el){
  let snaps=[...(DB().snapshots||[])];
  const from=document.getElementById('hf-from').value,to=document.getElementById('hf-to').value;
  if(from)snaps=snaps.filter(s=>s.date>=from);if(to)snaps=snaps.filter(s=>s.date<=to);
  if(!snaps.length){el.innerHTML=`<div style="padding:40px 0;text-align:center;font-size:14px;color:var(--muted2)">No daily snapshots yet. Snapshots are taken automatically at midnight each day when you have completed tasks.</div>`;return;}
  el.innerHTML=snaps.map(snap=>{const done=snap.tasks.filter(t=>t.done).length,pend=snap.tasks.length-done;return`<div class="snapshot-card"><div class="snapshot-date">${fmtDate(snap.ts||new Date(snap.date).getTime())}</div><div class="snapshot-stats"><div class="snapshot-stat"><strong>${snap.tasks.length}</strong> total</div><div class="snapshot-stat"><strong style="color:var(--accent)">${done}</strong> completed</div><div class="snapshot-stat"><strong style="color:var(--muted)">${pend}</strong> pending</div></div><div class="snapshot-tasks">${snap.tasks.slice(0,12).map(t=>`<div class="snapshot-task"><span class="${t.done?'st-done':'st-pending'}">${t.done?'‚úì':'‚óã'}</span><span style="flex:1;font-size:12px;${t.done?'text-decoration:line-through;color:var(--muted)':''}">${esc(t.text)}</span><span style="font-size:10px;color:var(--muted2)">${esc(t.catName)}${t.projName?' ‚Ä∫ '+esc(t.projName):''}</span></div>`).join('')}${snap.tasks.length>12?`<div style="font-size:11px;color:var(--muted2);padding:6px 0">‚Ä¶and ${snap.tasks.length-12} more tasks</div>`:''}</div></div>`;}).join('');
}

// VIEW SWITCHING
function switchView(v,btn){document.querySelectorAll('.nav-tab').forEach(b=>b.classList.remove('active'));document.querySelectorAll('.nav-tab[data-view="'+v+'"]').forEach(b=>b.classList.add('active'));['view-tasks','view-analytics','view-history'].forEach(id=>{document.getElementById(id).style.display=id.endsWith(v)?'block':'none';});if(v==='analytics')renderAnalytics();if(v==='history'){populateHistoryCatFilter();renderHistory();}}

// ANALYTICS
function setPeriod(p,btn){period=p;document.querySelectorAll('#view-analytics .period-row .pill').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderAnalytics();}
function periodTasks(){const now=Date.now();if(period==='week')return allTasks().filter(t=>t.ts>=now-7*DAY);if(period==='month')return allTasks().filter(t=>t.ts>=now-30*DAY);return allTasks();}
function renderAnalytics(){const pt=periodTasks(),total=pt.length,done=pt.filter(t=>t.done).length,rate=total?Math.round(done/total*100):0,apids=new Set(pt.map(t=>t.projId));document.getElementById('a-total').textContent=total;document.getElementById('a-done').textContent=done;document.getElementById('a-rate').textContent=rate+'%';document.getElementById('a-projs').textContent=apids.size;renderBarChart(pt);renderDonut(pt);renderInsights(pt);renderProjTable(pt);renderHeatmap();}
function renderBarChart(pt){const el=document.getElementById('bar-chart'),ttl=document.getElementById('bar-ttl');let cols=[];if(period==='month'){for(let i=3;i>=0;i--){const e=Date.now()-i*7*DAY,s=e-7*DAY,wt=pt.filter(t=>t.ts>=s&&t.ts<e);cols.push({lbl:new Date(s).toLocaleDateString('en-US',{month:'short',day:'numeric'}),total:wt.length,done:wt.filter(t=>t.done).length});}ttl.textContent='Tasks per Week ‚Äî This Month';}else{for(let i=6;i>=0;i--){const d=new Date();d.setHours(0,0,0,0);d.setDate(d.getDate()-i);const s=d.getTime(),e=s+DAY,day=pt.filter(t=>t.ts>=s&&t.ts<e);cols.push({lbl:d.toLocaleDateString('en-US',{weekday:'short'}),total:day.length,done:day.filter(t=>t.done).length});}ttl.textContent='Tasks per Day ‚Äî '+(period==='week'?'This Week':'Last 7 Days');}const maxT=Math.max(...cols.map(c=>c.total),1);el.innerHTML=cols.map(c=>{const ht=Math.round(c.total/maxT*100),dp=c.total?Math.round(c.done/c.total*100):0;return`<div class="bar-col"><div class="bar-val">${c.total||'¬∑'}</div><div class="bar-body"><div class="bar-stack" style="height:${ht}%;width:100%"><div class="seg-done" style="height:${dp}%"></div><div class="seg-pend" style="height:${100-dp}%"></div></div></div><div class="bar-lbl">${c.lbl}</div></div>`;}).join('');}
function renderDonut(pt){const counts={};cats().forEach(c=>counts[c.id]=0);pt.forEach(t=>{const p=projById(t.projId);if(p)counts[p.catId]=(counts[p.catId]||0)+1;});const total=pt.length||1,R=34,cx=50,cy=50,sw=15,circ=2*Math.PI*R;let offset=0,svg=`<circle cx="${cx}" cy="${cy}" r="${R}" fill="none" stroke="var(--surface2)" stroke-width="${sw}"/>`,legend='';cats().forEach(cat=>{const n=counts[cat.id]||0,len=(n/total)*circ;if(n>0)svg+=`<circle cx="${cx}" cy="${cy}" r="${R}" fill="none" stroke="${cat.color}" stroke-width="${sw}" stroke-dasharray="${len} ${circ}" stroke-dashoffset="${-offset}" transform="rotate(-90 ${cx} ${cy})"/>`;offset+=len;legend+=`<div class="legend-item"><div class="legend-dot" style="background:${cat.color}"></div><div class="legend-label">${esc(cat.name)}</div><div class="legend-val">${n}</div></div>`;});document.getElementById('donut-svg').innerHTML=svg;document.getElementById('donut-legend').innerHTML=legend;}
function renderInsights(pt){const el=document.getElementById('insights');if(!pt.length){el.innerHTML=`<div style="color:var(--muted);font-size:13px">No data for this period.</div>`;return;}const pd={};pt.filter(t=>t.done).forEach(t=>{pd[t.projId]=(pd[t.projId]||0)+1;});const tpe=Object.entries(pd).sort((a,b)=>b[1]-a[1])[0],tp=tpe?projById(tpe[0]):null;const cd={};pt.filter(t=>t.done).forEach(t=>{const p=projById(t.projId);if(p)cd[p.catId]=(cd[p.catId]||0)+1;});const tce=Object.entries(cd).sort((a,b)=>b[1]-a[1])[0],tc=tce?catById(tce[0]):null;const dc=[0,0,0,0,0,0,0];pt.forEach(t=>dc[new Date(t.ts).getDay()]++);const bd=dc.indexOf(Math.max(...dc)),dN=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];const ct={},cdc2={};pt.forEach(t=>{const p=projById(t.projId);if(p){ct[p.catId]=(ct[p.catId]||0)+1;if(t.done)cdc2[p.catId]=(cdc2[p.catId]||0)+1;}});const br=Object.entries(ct).map(([id,tot])=>({id,rate:Math.round(((cdc2[id]||0)/tot)*100)})).sort((a,b)=>b.rate-a.rate)[0],bc=br?catById(br.id):null;el.innerHTML=`${tp?`<div class="insight-item"><div class="insight-lbl">Top Project</div><div class="insight-val" style="color:${catById(tp.catId)?.color||'var(--accent)'}">‚óÜ ${esc(tp.name)}<em>${tpe[1]} done</em></div></div>`:''}${tc?`<div class="insight-item"><div class="insight-lbl">Top Category</div><div class="insight-val" style="color:${tc.color}">‚óÜ ${esc(tc.name)}<em>${tce[1]} completed</em></div></div>`:''}<div class="insight-item"><div class="insight-lbl">Busiest Day</div><div class="insight-val">‚óÜ ${dN[bd]}<em>${dc[bd]} tasks</em></div></div>${bc?`<div class="insight-item"><div class="insight-lbl">Best Rate</div><div class="insight-val" style="color:${bc.color}">‚óÜ ${esc(bc.name)}<em>${br.rate}% done</em></div></div>`:''}`;  }
function renderProjTable(pt){const tbody=document.getElementById('proj-tbody');const pids=[...new Set(pt.map(t=>t.projId))];if(!pids.length){tbody.innerHTML=`<tr><td colspan="5" style="color:var(--muted);font-size:13px;padding:14px 0">No data for this period.</td></tr>`;return;}const rows=pids.map(pid=>{const proj=projById(pid);if(!proj)return null;const cat=catById(proj.catId),pT=pt.filter(t=>t.projId===pid),pD=pT.filter(t=>t.done).length,rate=pT.length?Math.round(pD/pT.length*100):0;return{proj,cat,total:pT.length,done:pD,rate};}).filter(Boolean).sort((a,b)=>b.total-a.total);tbody.innerHTML=rows.map(r=>`<tr><td style="color:var(--text)">${esc(r.proj.name)}<div class="proj-row-bar" style="background:linear-gradient(to right,${r.cat?.color||'var(--accent)'} ${r.rate}%,var(--border2) ${r.rate}%)"></div></td><td><span class="proj-cat-dot" style="background:${r.cat?.color||'var(--muted)'}"></span><span style="font-size:12px;color:var(--muted)">${esc(r.cat?.name||'‚Äî')}</span></td><td style="text-align:center;color:var(--muted)">${r.total}</td><td style="text-align:center">${r.done}</td><td style="text-align:right;color:${r.rate>=70?'var(--accent)':r.rate>=40?'#f7c07e':'var(--muted)'}">${r.rate}%</td></tr>`).join('');}
function renderHeatmap(){const el=document.getElementById('heatmap');const today=new Date();today.setHours(0,0,0,0);const gs=new Date(today);gs.setDate(gs.getDate()-today.getDay()-28);const dm={};allTasks().forEach(t=>{const k=sod(t.ts);dm[k]=(dm[k]||0)+1;});const maxV=Math.max(...Object.values(dm),1);let html=['S','M','T','W','T','F','S'].map(d=>`<div class="hm-lbl">${d}</div>`).join('');for(let i=0;i<35;i++){const d=new Date(gs);d.setDate(d.getDate()+i);d.setHours(0,0,0,0);const key=d.getTime(),count=dm[key]||0,future=d>today;const bg=future?'transparent':count===0?'var(--surface2)':`rgba(200,245,74,${(0.15+0.85*(count/maxV)).toFixed(2)})`;const tip=d.toLocaleDateString('en-US',{month:'short',day:'numeric'})+`: ${count} task${count!==1?'s':''}`;html+=`<div class="hm-cell" style="background:${bg}" ${!future?`data-tip="${tip}"`:''}></div>`;}el.innerHTML=html;}

// TOAST
function toast(msg,type='success'){const el=document.createElement('div');el.className=`toast ${type}`;el.innerHTML=`<div class="toast-dot"></div>${esc(msg)}`;document.body.appendChild(el);setTimeout(()=>{el.style.opacity='0';el.style.transition='opacity .3s';setTimeout(()=>el.remove(),320);},3500);}

// INIT
function onResize(){if(window.innerWidth>768)closeSidebar();}
async function init(){loadLocal();loadTheme();updateProfileScreenStatus();await initData();if(ghToken&&ghGistId){setSyncStatus('synced');startAutoSync();}window.addEventListener('resize',onResize);}
init();
</script>
</body>
</html>